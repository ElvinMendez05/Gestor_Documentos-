@model List<Document_Manager.Application.DTOs.DocumentDto>

@{
    ViewData["Title"] = "Mis Documentos";
}

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">

<style>
    :root {
        --primary: #1D4ED8;
        --primary-light: #eff6ff;
        --accent: #2563EB;
        --danger: #ef4444;
        --text-main: #1f2937;
        --text-muted: #6b7280;
        --bg-body: #f8faff;
    }

    body {
        background-color: var(--bg-body);
        color: var(--text-main);
        font-family: 'Inter', system-ui, -apple-system, sans-serif;
    }

    /* === HEADER ESTRUCTURA === */
    .page-header {
        background: white;
        padding: 2rem 0;
        margin-bottom: 2rem;
        border-bottom: 1px solid #e5e7eb;
    }

    .search-container {
        position: relative;
        max-width: 500px;
        left: 150px;
    }

        .search-container i {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
        }

    .search-input {
        padding: 12px 16px 12px 48px;
        border-radius: 12px;
        border: 1px solid #e5e7eb;
        width: 100%;
        background: #f9fafb;
    }

    /* === ESTILOS DEL MODAL Y UPLOAD AREA === */
    .upload-area {
        border: 2px dashed #e2e8f0;
        border-radius: 20px;
        padding: 40px 20px;
        transition: all 0.2s ease-in-out;
        cursor: pointer;
        background: #ffffff;
        text-align: center;
    }

        .upload-area:hover, .upload-area.dragover {
            border-color: var(--accent);
            background: var(--primary-light);
        }

    .upload-icon-circle {
        width: 60px;
        height: 60px;
        background: var(--primary-light);
        border-radius: 50%;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        color: var(--accent);
        font-size: 1.5rem;
    }

    /* === ESTILOS DE DOCUMENTOS (GRID) === */
    .doc-card {
        background: white;
        border-radius: 20px;
        border: 1px solid #f0f2f5;
        transition: all 0.3s ease;
        height: 100%;
        display: flex;
        flex-direction: column;
    }

        .doc-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px -5px rgba(29,78,216,0.1);
        }

    .doc-preview {
        height: 140px;
        background: #f1f5f9;
        border-radius: 20px 20px 0 0;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
    }

        .doc-preview i {
            font-size: 3.5rem;
            color: #cbd5e1;
        }

    .doc-actions {
        padding: 1rem;
        border-top: 1px solid #f3f4f6;
        display: flex;
        gap: 8px;
    }

    .btn-action-view {
        background: var(--primary-light);
        color: var(--primary);
        border: none;
        border-radius: 10px;
        flex: 1;
        font-weight: 600;
        padding: 8px;
    }

    .btn-action-delete {
        background: #fff5f5;
        color: var(--danger);
        border: none;
        border-radius: 10px;
        width: 40px;
    }
</style>

<div class="page-header">
    <div class="container d-flex flex-column flex-md-row justify-content-between align-items-center gap-3">
        <div>
            <h2 class="fw-bold mb-1">Mis Documentos</h2>
            <p class="text-muted mb-0">Gestiona y visualiza tus archivos PDF.</p>
        </div>

        <div class="search-container flex-grow-1 mx-md-4">
            <i class="bi bi-search"></i>
            <input type="text" id="docSearch" class="search-input" placeholder="Buscar por nombre...">
        </div>

        <button type="button" class="btn btn-primary px-4 py-2 rounded-3 fw-bold shadow-sm" data-bs-toggle="modal" data-bs-target="#uploadModal">
            <i class="bi bi-cloud-plus-fill me-2"></i> Subir Archivo
        </button>
    </div>
</div>

<div class="container pb-5">
    @if (!Model.Any())
    {
        <div class="text-center py-5 bg-white rounded-4 border-2 border-dashed mt-4">
            <i class="bi bi-folder2-open display-1 text-light"></i>
            <h3 class="fw-bold mt-3">No hay documentos</h3>
            <p class="text-muted">Parece que aún no has subido ningún archivo.</p>
        </div>
    }
    else
    {
        <div class="row g-4" id="documentsGrid">
            @foreach (var doc in Model)
            {
                <div class="col-12 col-md-6 col-lg-4 col-xl-3 doc-item" data-title="@doc.FileName.ToLower()">
                    <div class="doc-card">
                        <div class="doc-preview">
                            <i class="bi bi-file-earmark-pdf-fill"></i>
                        </div>
                        <div class="p-3 flex-grow-1">
                            <span class="fw-bold d-block text-truncate" title="@doc.FileName">@doc.FileName</span>
                            <small class="text-muted"><i class="bi bi-calendar-event me-1"></i>@doc.CreatedAt.ToString("dd MMM, yyyy")</small>
                        </div>
                        <div class="doc-actions">
                            <button class="btn-action-view" data-bs-toggle="modal" data-bs-target="#pdfModal" data-pdf="@doc.FilePath">
                                <i class="bi bi-eye-fill me-1"></i> Ver
                            </button>
                            <form asp-action="Delete" asp-route-id="@doc.Id" method="post" onsubmit="return confirm('¿Eliminar documento?');">
                                <button type="submit" class="btn-action-delete py-2"><i class="bi bi-trash3-fill"></i></button>
                            </form>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
</div>

<div class="modal fade" id="uploadModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg rounded-4">
            <div class="modal-header border-bottom px-4 py-3">
                <h5 class="modal-title fw-bold">Subir Documentos</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <form asp-action="Upload" method="post" enctype="multipart/form-data">
                <div class="modal-body p-4">
                    <div class="upload-area d-flex flex-column align-items-center justify-content-center" id="dropZone">
                        <div class="upload-icon-circle mb-3">
                            <i class="bi bi-upload"></i>
                        </div>
                        <h6 class="fw-bold mb-1">Arrastra tus archivos aquí</h6>
                        <p class="text-muted small mb-0">o <span class="text-primary fw-semibold">selecciona archivos</span></p>
                        <p class="text-muted" style="font-size: 0.7rem;">Solo PDF (máx. 50MB)</p>

                        <input type="file" name="file" id="fileInput" accept=".pdf" class="d-none" required>

                        <div id="fileInfo" class="mt-3 d-none w-100">
                            <div class="alert alert-primary d-flex align-items-center mb-0 py-2">
                                <i class="bi bi-file-earmark-check-fill me-2"></i>
                                <small id="fileNameDisplay" class="text-truncate"></small>
                            </div>
                        </div>
                    </div>
                </div>


                <div class="modal-footer border-top px-4 py-3 gap-2">
                    <button type="button" class="btn btn-light rounded-pill px-4" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary rounded-pill px-4 shadow-sm">Subir ahora</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="pdfModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg rounded-4 overflow-hidden">
            <div class="modal-header border-bottom">
                <h5 class="modal-title fw-bold"><i class="bi bi-file-earmark-pdf text-danger me-2"></i>Vista Previa</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-0 bg-dark">
                <iframe id="pdfViewer" style="width:100%; height:75vh; border:none; display:block;"></iframe>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const fileInfo = document.getElementById('fileInfo');
        const fileNameDisplay = document.getElementById('fileNameDisplay');

        dropZone.addEventListener('click', () => fileInput.click());

        function handleFile(file) {
            if (file && file.type === "application/pdf") {
                const dt = new DataTransfer();
                dt.items.add(file);
                fileInput.files = dt.files;
                fileNameDisplay.textContent = file.name;
                fileInfo.classList.remove('d-none');
            }
        }

        fileInput.addEventListener('change', e => handleFile(e.target.files[0]));

        ['dragover', 'dragleave', 'drop'].forEach(name => {
            dropZone.addEventListener(name, e => { e.preventDefault(); e.stopPropagation(); });
        });

        dropZone.addEventListener('dragover', () => dropZone.classList.add('dragover'));
        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
        dropZone.addEventListener('drop', e => {
            dropZone.classList.remove('dragover');
            handleFile(e.dataTransfer.files[0]);
        });

        // Visor PDF
        document.getElementById('pdfModal').addEventListener('show.bs.modal', e => {
            const url = e.relatedTarget.getAttribute('data-pdf');
            document.getElementById('pdfViewer').src = url;
        });

        // Buscador
        document.getElementById('docSearch').addEventListener('input', e => {
            const term = e.target.value.toLowerCase();
            document.querySelectorAll('.doc-item').forEach(item => {
                item.style.display = item.dataset.title.includes(term) ? 'block' : 'none';
            });
        });
    </script>
}